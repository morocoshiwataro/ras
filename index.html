<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>荒野の王（WK）計算フォーム</title>
  <style>
    :root { --bd:#ddd; --bg:#fafafa; --warn:#c00; --ok:#0a7; }
    body { font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif; max-width: 980px; margin: 20px auto; padding: 0 14px; line-height: 1.45; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    h2 { font-size: 16px; margin: 22px 0 10px; }
    .card { border: 1px solid var(--bd); border-radius: 12px; padding: 14px; background: white; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 820px){ .row { grid-template-columns: 1fr; } }
    label { display: block; font-weight: 650; margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--bd); border-radius: 10px; font-size: 14px; background: white; }
    .muted { color:#666; font-size: 12px; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--bd); background: var(--bg); cursor: pointer; }
    button.primary { background: #111; color: white; border-color:#111; }
    .result { margin-top: 12px; border-top: 1px dashed var(--bd); padding-top: 12px; }
    .kpi { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width: 820px){ .kpi { grid-template-columns: 1fr; } }
    .k { border: 1px solid var(--bd); border-radius: 12px; padding: 12px; background: var(--bg); }
    .k b { font-size: 16px; display:block; margin-top: 4px; }
    .warn { color: var(--warn); font-weight: 800; }
    .ok { color: var(--ok); font-weight: 800; }
    .hidden { display:none; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--bd); padding: 8px; text-align: right; font-variant-numeric: tabular-nums; }
    th:first-child, td:first-child { text-align: left; }
    .foot { margin-top: 14px; font-size: 12px; color:#666; }
    .hr { height: 1px; background: var(--bd); margin: 14px 0; }
    .pill { display:inline-block; padding: 2px 8px; border:1px solid var(--bd); border-radius: 999px; font-size: 12px; background: var(--bg); }
  </style>
</head>
<body>
  <h1>荒野の王（WK）計算フォーム</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>① 病院容量（現在の深部容量）<span class="pill">必須</span></label>
        <input id="hospitalCap" type="number" min="0" step="1" placeholder="例：132750" />
        <div class="muted">単位：人（収容できる最大数）</div>
      </div>
      <div>
        <label>② アフターショック率 <span class="pill">必須</span></label>
        <input id="aftershockRate" type="number" min="0" step="0.01" placeholder="例：14" />
        <div class="muted">入力は「%の数値」（例：14% → 14）</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div>
        <label>目的 <span class="pill">必須</span></label>
        <select id="mode">
          <option value="A">A：兵士をたくさん増やしたい（安全に突撃できる最大兵士数→内訳入力）</option>
          <option value="B">B：ポイントから逆算したい（目標ポイント→必要突撃人数）</option>
        </select>
      </div>
      <div id="targetWrap" class="hidden">
        <label>③ ほしいポイント数（1000単位）<span class="pill">必須（Bのみ）</span></label>
        <input id="targetPoints" type="number" min="0" step="1000" placeholder="例：50000" />
        <div class="muted">1000刻みで入力してください（例：50000）</div>
      </div>
    </div>

    <!-- A -->
    <div id="sectionA" class="result">
      <h2>A：安全最大人数 → 兵士ランク内訳 → 合計ポイント</h2>
      <div class="kpi">
        <div class="k">
          安全に突撃できる最大兵士数（推奨上限）
          <b id="aMaxSafe">-</b>
          <div class="muted">式：① ÷（0.7 + ②×0.003）</div>
        </div>
        <div class="k">
          入力した突撃人数 合計
          <b id="aTotalSoldiers">-</b>
          <div class="muted">最大兵士数を超えると警告</div>
        </div>
        <div class="k">
          合計ポイント（兵士ランクごと）
          <b id="aTotalPoints">-</b>
          <div class="muted">④（下表）×人数 の合計</div>
        </div>
      </div>

      <div style="margin-top:12px;" class="muted">
        ※各ランクの突撃人数を入力してください（自動でポイント計算します）
      </div>

      <div style="margin-top:8px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>兵士ランク</th>
              <th>④ 1人あたりポイント</th>
              <th>突撃人数</th>
              <th>ポイント小計</th>
            </tr>
          </thead>
          <tbody id="aTableBody"></tbody>
        </table>
      </div>

      <div id="aWarn" class="warn" style="margin-top:10px;"></div>
    </div>

    <!-- B -->
    <div id="sectionB" class="result hidden">
      <h2>B：目標ポイント → 必要“死亡数ポイント（=累計値）” → 必要突撃人数</h2>

      <div class="row">
        <div>
          <label>現在獲得しているポイントは？</label>
          <select id="hasCurrentPoints">
            <option value="no">ない（0）</option>
            <option value="yes">ある（入力する）</option>
          </select>
        </div>
        <div id="currentPointsWrap" class="hidden">
          <label>現在獲得しているポイント</label>
          <input id="currentPoints" type="number" min="0" step="1" placeholder="例：12000" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>メインで突撃させる兵士ランク</label>
          <select id="mainRank"></select>
        </div>
        <div>
          <label>計算</label>
          <div class="btnrow">
            <button class="primary" id="calcB">Bを計算する</button>
            <button id="toggleIrregular" disabled>兵士が1種類では足りない場合</button>
          </div>
          <div class="muted">※Bを先に計算してから、イレギュラーを押してください</div>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px;">
        <div class="k">
          目標までの不足ポイント（③−現在）
          <b id="bNeedPoints">-</b>
        </div>
        <div class="k">
          ⑤ 必要な死亡数ポイント（累計値）
          <b id="bNeedDeathPoints">-</b>
          <div class="muted">不足ポイントを達成する最小の累計値（下の到達表に基づく）</div>
        </div>
        <div class="k">
          必要突撃人数（メイン）
          <b id="bNeedSoldiers">-</b>
        </div>
      </div>

      <div id="bWarn" class="warn" style="margin-top:10px;"></div>

      <!-- Irregular -->
      <div id="irregularBox" class="card hidden" style="margin-top:14px;">
        <h2>イレギュラー：兵士を2種類で突撃する</h2>

        <div class="row">
          <div>
            <label>サブで突撃させる兵士ランク</label>
            <select id="subRank"></select>
          </div>
          <div>
            <label>⑥ メインで突撃させる兵士数（入力）</label>
            <input id="mainCountManual" type="number" min="0" step="1" placeholder="例：20000" />
            <div class="muted">B計算で出た必要人数より少なめで入力する想定</div>
          </div>
        </div>

        <div class="btnrow">
          <button class="primary" id="calcIrregular">サブ人数を算出</button>
        </div>

        <div class="kpi" style="margin-top:12px;">
          <div class="k">
            サブ必要人数（算出）
            <b id="iSubNeed">-</b>
          </div>
          <div class="k">
            合計人数（メイン+サブ）
            <b id="iTotal">-</b>
          </div>
          <div class="k">
            使用する死亡数ポイント（累計値）
            <b id="iNeedDeathPoints">-</b>
          </div>
        </div>

        <div id="iWarn" class="warn" style="margin-top:10px;"></div>

        <div class="foot">
          ※計算式（仕様に合わせた形）<br/>
          必要累計値 －（メイン人数×メインの④）を、サブの④で割ってサブ人数を出します。<br/>
          （※仕様文中の式の分母に「×⑥」がありますが、単位の整合性のためここでは「サブの④」で割る形にしています）
        </div>
      </div>

      <div class="foot" style="margin-top:12px;">
        ⑤（死亡数ポイント→ポイントの到達表）は「累計死亡数ポイント」を積み上げて到達した分だけ加算されます（例：40000到達なら 100+150+200）。<br/>
        100万を超えた分は、50万到達ごとに +200 として扱います。
      </div>
    </div>

    <div class="hr"></div>

    <div class="foot">
      <b>利用条件</b><br/>
      本ページは、閲覧者が個人的に計算を行う目的に限り利用できます。<br/>
      本ページの計算内容・ロジック・数式・ソースコード等の転載は禁止での転載・流用・再配布・二次利用（別サイト/アプリ等への組み込みを含む）を禁止します。
    </div>
  </div>

<script>
(() => {
  // ④ 兵士ランクごとのポイント
  const RANK_POINTS = {
    "T6": 20,
    "T7": 25,
    "T8": 33,
    "T9": 45,
    "T10": 60,
    "T11": 80,
    "T12": 100,
    "T13": 125,
  };

  // ⑤ 到達表（累計死亡数ポイント → 加算ポイント）
  // 「到達したら加算される」ので、累計値が閾値を超えた分だけ足す
  const MILESTONES = [
    { deathPoints: 10000, addPoints: 100 },
    { deathPoints: 20000, addPoints: 150 },
    { deathPoints: 40000, addPoints: 200 },
    { deathPoints: 100000, addPoints: 250 },
    { deathPoints: 200000, addPoints: 300 },
    { deathPoints: 300000, addPoints: 350 },
    { deathPoints: 400000, addPoints: 400 },
    { deathPoints: 600000, addPoints: 450 },
    { deathPoints: 800000, addPoints: 500 },
    { deathPoints: 1000000, addPoints: 600 },
  ];
  const AFTER_1M_STEP = 500000;
  const AFTER_1M_ADD = 200;

  const $ = (id) => document.getElementById(id);

  function num(v, fallback = 0) {
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function fmt(n, digits=0) {
    if (!Number.isFinite(n)) return "-";
    return n.toLocaleString("ja-JP", { maximumFractionDigits: digits });
  }

  function ceil(n) {
    if (!Number.isFinite(n)) return NaN;
    return Math.ceil(n);
  }

  // ①÷（0.7＋②×0.003）
  function calcMaxSafe(hospitalCap, aftershockRatePercent) {
    const denom = 0.7 + (aftershockRatePercent * 0.003);
    if (denom <= 0) return NaN;
    return hospitalCap / denom;
  }

  // 累計死亡数ポイント(deathPoints)から、獲得ポイントを計算（到達ごとに加算）
  function pointsFromDeathPoints(deathPoints) {
    let p = 0;
    for (const m of MILESTONES) {
      if (deathPoints >= m.deathPoints) p += m.addPoints;
    }
    if (deathPoints > 1000000) {
      const extra = deathPoints - 1000000;
      const blocks = Math.floor(extra / AFTER_1M_STEP); // 50万ごと
      p += blocks * AFTER_1M_ADD;
    }
    return p;
  }

  // 不足ポイント(needPoints)を満たす最小の「必要累計死亡数ポイント」を探す（逆算）
  // まず1,000,000までを探索→それ以上は50万ごとに200なので段階的に伸ばす
  function minDeathPointsForNeedPoints(needPoints) {
    if (needPoints <= 0) return 0;

    // 0～1,000,000は閾値候補を昇順で見れば足りる
    const candidates = [0, ...MILESTONES.map(m => m.deathPoints)];
    for (const dp of candidates) {
      if (pointsFromDeathPoints(dp) >= needPoints) return dp;
    }

    // 1,000,000でも足りない → 50万ブロックを足していく
    let dp = 1000000;
    while (pointsFromDeathPoints(dp) < needPoints) {
      dp += AFTER_1M_STEP;
      // 安全のため無限ループ回避（通常あり得ないが）
      if (dp > 50000000) break;
    }
    return dp;
  }

  // UI: ランク選択肢
  function fillRankSelect(sel) {
    sel.innerHTML = "";
    for (const r of Object.keys(RANK_POINTS)) {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = `${r}（${RANK_POINTS[r]}）`;
      sel.appendChild(opt);
    }
  }

  // UI: Aのテーブル作成
  function buildATable() {
    const body = $("aTableBody");
    body.innerHTML = "";

    for (const r of Object.keys(RANK_POINTS)) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r}</td>
        <td>${fmt(RANK_POINTS[r])}</td>
        <td><input data-rank="${r}" class="aCount" type="number" min="0" step="1" placeholder="0" style="text-align:right;"></td>
        <td id="sub_${r}">0</td>
      `;
      body.appendChild(tr);
    }

    body.querySelectorAll(".aCount").forEach(inp => {
      inp.addEventListener("input", updateA);
    });
  }

  function commonInputsOK() {
    const cap = num($("hospitalCap").value, NaN);
    const rate = num($("aftershockRate").value, NaN);
    return Number.isFinite(cap) && cap >= 0 && Number.isFinite(rate) && rate >= 0;
  }

  // A更新
  function updateA() {
    const cap = num($("hospitalCap").value, NaN);
    const rate = num($("aftershockRate").value, NaN);

    const maxSafeRaw = calcMaxSafe(cap, rate);
    const maxSafe = ceil(maxSafeRaw);

    let totalSoldiers = 0;
    let totalPoints = 0;

    document.querySelectorAll(".aCount").forEach(inp => {
      const r = inp.dataset.rank;
      const c = Math.max(0, Math.floor(num(inp.value, 0)));
      totalSoldiers += c;
      const sub = c * RANK_POINTS[r];
      totalPoints += sub;
      $("sub_" + r).textContent = fmt(sub);
    });

    $("aMaxSafe").textContent = Number.isFinite(maxSafe) ? fmt(maxSafe) : "-";
    $("aTotalSoldiers").textContent = fmt(totalSoldiers);
    $("aTotalPoints").textContent = fmt(totalPoints);

    const warn = [];
    if (Number.isFinite(maxSafe) && totalSoldiers > maxSafe) {
      warn.push(`最大兵士数（推奨上限）を超えています：${fmt(totalSoldiers)} > ${fmt(maxSafe)}`);
    }
    if (Number.isFinite(cap) && totalSoldiers > cap) {
      warn.push(`病院容量（①）を超えています：${fmt(totalSoldiers)} > ${fmt(cap)}`);
    }
    $("aWarn").textContent = warn.join(" / ");
  }

  // B表示更新（ボタン押下で計算）
  let lastNeedDeathPoints = 0; // B計算の結果（累計値）
  function calcB() {
    const cap = num($("hospitalCap").value, NaN);
    const target = num($("targetPoints").value, NaN);

    if (!Number.isFinite(target) || target < 0) {
      $("bWarn").textContent = "③ ほしいポイント数（1000単位）を入力してください。";
      return;
    }
    if (target % 1000 !== 0) {
      $("bWarn").textContent = "③ は1000刻みで入力してください。";
      return;
    }

    const hasCur = $("hasCurrentPoints").value === "yes";
    const cur = hasCur ? num($("currentPoints").value, 0) : 0;

    const needPoints = Math.max(0, target - cur);
    $("bNeedPoints").textContent = fmt(needPoints);

    // 不足ポイント → 必要な累計死亡数ポイント（最小）
    const needDeathPoints = minDeathPointsForNeedPoints(needPoints);
    lastNeedDeathPoints = needDeathPoints;
    $("bNeedDeathPoints").textContent = fmt(needDeathPoints);

    const mainRank = $("mainRank").value;
    const per = RANK_POINTS[mainRank];

    const needSoldiers = per > 0 ? Math.ceil(needDeathPoints / per) : NaN;
    $("bNeedSoldiers").textContent = Number.isFinite(needSoldiers) ? fmt(needSoldiers) : "-";

    const warn = [];
    const rate = num($("aftershockRate").value, NaN);
    const factor = 0.7 + (rate * 0.003);

    if (
     Number.isFinite(cap) &&
      Number.isFinite(needSoldiers) &&
      Number.isFinite(factor) &&
      (needSoldiers * factor) > cap
    ) {
     warn.push("病院容量を超えます");
    }

    $("bWarn").textContent = warn.join(" / ");

    // イレギュラー解禁
    $("toggleIrregular").disabled = false;
    $("iNeedDeathPoints").textContent = fmt(lastNeedDeathPoints);
    $("iWarn").textContent = "";
  }

  function calcIrregular() {
    const cap = num($("hospitalCap").value, NaN);
    const mainRank = $("mainRank").value;
    const subRank = $("subRank").value;

    const mainPer = RANK_POINTS[mainRank];
    const subPer = RANK_POINTS[subRank];

    const mainCount = Math.max(0, Math.floor(num($("mainCountManual").value, NaN)));
    if (!Number.isFinite(mainCount)) {
      $("iWarn").textContent = "⑥ メインで突撃させる兵士数を入力してください。";
      return;
    }

    // 必要累計値（Bで求めた）から、メイン分を引いて残りをサブで埋める
    const remainDeathPoints = Math.max(0, lastNeedDeathPoints - (mainCount * mainPer));
    const subNeed = subPer > 0 ? Math.ceil(remainDeathPoints / subPer) : NaN;

    const total = Number.isFinite(subNeed) ? (mainCount + subNeed) : NaN;

    $("iSubNeed").textContent = Number.isFinite(subNeed) ? fmt(subNeed) : "-";
    $("iTotal").textContent = Number.isFinite(total) ? fmt(total) : "-";
    $("iNeedDeathPoints").textContent = fmt(lastNeedDeathPoints);

    const warn = [];
    const rate = num($("aftershockRate").value, NaN);
    const factor = 0.7 + (rate * 0.003);

    if (
      Number.isFinite(cap) &&
      Number.isFinite(total) &&
      Number.isFinite(factor) &&
      (total * factor) > cap
    ) {
      warn.push("病院容量を超えます");
    }

  }

  function updateMode() {
    const mode = $("mode").value;
    const isA = mode === "A";
    $("sectionA").classList.toggle("hidden", !isA);
    $("sectionB").classList.toggle("hidden", isA);
    $("targetWrap").classList.toggle("hidden", isA);
  }

  function updateHasCurrent() {
    const yes = $("hasCurrentPoints").value === "yes";
    $("currentPointsWrap").classList.toggle("hidden", !yes);
  }

  // 初期化
  fillRankSelect($("mainRank"));
  fillRankSelect($("subRank"));
  buildATable();
  updateMode();
  updateHasCurrent();
  updateA();

  // イベント
  $("mode").addEventListener("change", updateMode);
  $("hasCurrentPoints").addEventListener("change", updateHasCurrent);

  // 共通入力が変わったらAは即更新（Bはボタン計算）
  $("hospitalCap").addEventListener("input", () => { updateA(); });
  $("aftershockRate").addEventListener("input", () => { updateA(); });

  $("calcB").addEventListener("click", calcB);

  $("toggleIrregular").addEventListener("click", () => {
    $("irregularBox").classList.toggle("hidden");
  });

  $("calcIrregular").addEventListener("click", calcIrregular);
})();
</script>
</body>
</html>
